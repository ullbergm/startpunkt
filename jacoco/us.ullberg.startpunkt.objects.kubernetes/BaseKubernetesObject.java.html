<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseKubernetesObject.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">startpunkt</a> &gt; <a href="index.source.html" class="el_package">us.ullberg.startpunkt.objects.kubernetes</a> &gt; <span class="el_source">BaseKubernetesObject.java</span></div><h1>BaseKubernetesObject.java</h1><pre class="source lang-java linenums">package us.ullberg.startpunkt.objects.kubernetes;

import io.fabric8.kubernetes.api.model.GenericKubernetesResource;
import io.fabric8.kubernetes.api.model.GenericKubernetesResourceList;
import io.fabric8.kubernetes.client.KubernetesClient;
import io.fabric8.kubernetes.client.dsl.base.ResourceDefinitionContext;
import io.quarkus.logging.Log;
import jakarta.annotation.Nullable;
import java.util.List;
import java.util.Map;
import us.ullberg.startpunkt.crd.v1alpha3.ApplicationSpec;

/**
 * Abstract base class representing a Kubernetes custom resource wrapper. Provides common
 * functionality to retrieve application specifications and metadata from Kubernetes generic
 * resources.
 */
public abstract class BaseKubernetesObject implements KubernetesObject {
  private String group;
  private String version;
  private String pluralKind;

  /**
   * Constructs the wrapper with the specified API group, version, and plural kind.
   *
   * @param group the API group of the Kubernetes resource
   * @param version the API version of the Kubernetes resource
   * @param pluralKind the plural kind name of the Kubernetes resource
   */
<span class="fc" id="L30">  protected BaseKubernetesObject(String group, String version, String pluralKind) {</span>
<span class="fc" id="L31">    this.group = group;</span>
<span class="fc" id="L32">    this.version = version;</span>
<span class="fc" id="L33">    this.pluralKind = pluralKind;</span>
<span class="fc" id="L34">  }</span>

  /**
   * Returns the API group of the Kubernetes resource.
   *
   * @return the API group string
   */
  public String getGroup() {
<span class="nc" id="L42">    return group;</span>
  }

  /**
   * Returns the API version of the Kubernetes resource.
   *
   * @return the API version string
   */
  public String getVersion() {
<span class="nc" id="L51">    return version;</span>
  }

  /**
   * Returns the plural kind name of the Kubernetes resource.
   *
   * @return the plural kind string
   */
  public String getPluralKind() {
<span class="nc" id="L60">    return pluralKind;</span>
  }

  /**
   * Builds a ResourceDefinitionContext for the Kubernetes custom resource.
   *
   * @return the resource definition context
   */
  private ResourceDefinitionContext getResourceDefinitionContext() {
<span class="fc" id="L69">    return new ResourceDefinitionContext.Builder()</span>
<span class="fc" id="L70">        .withGroup(group)</span>
<span class="fc" id="L71">        .withVersion(version)</span>
<span class="fc" id="L72">        .withPlural(pluralKind)</span>
<span class="fc" id="L73">        .withNamespaced(true)</span>
<span class="fc" id="L74">        .build();</span>
  }

  /**
   * Retrieves a list of generic Kubernetes resources of this type, filtered by namespaces.
   *
   * @param client the Kubernetes client instance
   * @param anyNamespace if true, searches across all namespaces; otherwise uses matchNames
   * @param matchNames list of namespace names to filter on (used only if anyNamespace is false)
   * @return list of GenericKubernetesResource objects
   */
  protected GenericKubernetesResourceList getGenericKubernetesResources(
      KubernetesClient client, boolean anyNamespace, List&lt;String&gt; matchNames) {
<span class="fc" id="L87">    ResourceDefinitionContext resourceDefinitionContext = getResourceDefinitionContext();</span>
<span class="fc" id="L88">    Log.debugf(&quot;Fetching %s/%s resources from Kubernetes&quot;, group, pluralKind);</span>

    try {
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">      if (anyNamespace) {</span>
<span class="fc" id="L92">        Log.debug(&quot;Searching across all namespaces&quot;);</span>
<span class="fc" id="L93">        GenericKubernetesResourceList result = client.genericKubernetesResources(resourceDefinitionContext).inAnyNamespace().list();</span>
<span class="fc" id="L94">        Log.debugf(&quot;Found %d %s resources in all namespaces&quot;, result.getItems().size(), pluralKind);</span>
<span class="fc" id="L95">        return result;</span>
      }

<span class="nc" id="L98">      GenericKubernetesResourceList list = new GenericKubernetesResourceList();</span>
<span class="nc" id="L99">      Log.debugf(&quot;Searching in specific namespaces: %s&quot;, matchNames);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">      for (String namespace : matchNames) {</span>
<span class="nc" id="L101">        var items = client</span>
<span class="nc" id="L102">                    .genericKubernetesResources(resourceDefinitionContext)</span>
<span class="nc" id="L103">                    .inNamespace(namespace)</span>
<span class="nc" id="L104">                    .list()</span>
<span class="nc" id="L105">                    .getItems();</span>
<span class="nc" id="L106">        Log.debugf(&quot;Found %d %s resources in namespace: %s&quot;, items.size(), pluralKind, namespace);</span>
<span class="nc" id="L107">        list.getItems().addAll(items);</span>
<span class="nc" id="L108">      }</span>

<span class="nc" id="L110">      Log.debugf(&quot;Total %s resources found: %d&quot;, pluralKind, list.getItems().size());</span>
<span class="nc" id="L111">      return list;</span>
<span class="nc" id="L112">    } catch (Exception ex) {</span>
<span class="nc" id="L113">      Log.warnf(&quot;Error retrieving %s/%s resources: %s&quot;, group, pluralKind, ex.getMessage());</span>
      // Returning empty list if retrieval fails. Consider improving error handling.
<span class="nc" id="L115">      return new GenericKubernetesResourceList();</span>
    }
  }

  /**
   * Retrieves application specifications by mapping Kubernetes generic resources.
   *
   * @param client the Kubernetes client instance
   * @param anyNamespace whether to search across all namespaces
   * @param matchNames list of namespaces to filter on if anyNamespace is false
   * @return list of ApplicationSpec instances
   */
  public List&lt;ApplicationSpec&gt; getApplicationSpecs(
      KubernetesClient client, boolean anyNamespace, List&lt;String&gt; matchNames) {
<span class="fc" id="L129">    return getGenericKubernetesResources(client, anyNamespace, matchNames).getItems().stream()</span>
<span class="fc" id="L130">        .map(this::mapToApplicationSpec)</span>
<span class="fc" id="L131">        .toList();</span>
  }

  /**
   * Maps a GenericKubernetesResource to an ApplicationSpec instance.
   *
   * @param item the Kubernetes generic resource
   * @return the ApplicationSpec mapped from the resource
   */
  protected ApplicationSpec mapToApplicationSpec(GenericKubernetesResource item) {
<span class="fc" id="L141">    return new ApplicationSpec(</span>
<span class="fc" id="L142">        getAppName(item),</span>
<span class="fc" id="L143">        getAppGroup(item),</span>
<span class="fc" id="L144">        getAppIcon(item),</span>
<span class="fc" id="L145">        getAppIconColor(item),</span>
<span class="fc" id="L146">        getAppUrl(item),</span>
<span class="fc" id="L147">        getAppInfo(item),</span>
<span class="fc" id="L148">        getAppTargetBlank(item),</span>
<span class="fc" id="L149">        getAppLocation(item),</span>
<span class="fc" id="L150">        getAppEnabled(item),</span>
<span class="fc" id="L151">        getAppRootPath(item),</span>
<span class="fc" id="L152">        getAppTags(item));</span>
  }

  /**
   * Returns the annotations map from the Kubernetes resource metadata.
   *
   * @param item the Kubernetes generic resource
   * @return map of annotations or null if none present
   */
  protected Map&lt;String, String&gt; getAnnotations(GenericKubernetesResource item) {
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">    if (item.getMetadata() == null) {</span>
<span class="nc" id="L163">      return null;</span>
    }
<span class="fc" id="L165">    return item.getMetadata().getAnnotations();</span>
  }

  /**
   * Returns the spec map from the Kubernetes resource.
   *
   * @param item the Kubernetes generic resource
   * @return spec map or null if not present
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  protected Map&lt;String, Object&gt; getSpec(GenericKubernetesResource item) {
<span class="fc" id="L176">    Map&lt;String, Object&gt; props = getProps(item);</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">    if (props == null) {</span>
<span class="nc" id="L178">      return Map.of();</span>
    }
<span class="fc" id="L180">    return (Map&lt;String, Object&gt;) props.get(&quot;spec&quot;);</span>
  }

  /**
   * Returns additional properties map from the Kubernetes resource.
   *
   * @param item the Kubernetes generic resource
   * @return map of additional properties or null if none present
   */
  protected Map&lt;String, Object&gt; getProps(GenericKubernetesResource item) {
<span class="fc" id="L190">    return item.getAdditionalProperties();</span>
  }

  /**
   * Returns the application name. Defaults to resource metadata name in lowercase.
   *
   * @param item the Kubernetes generic resource
   * @return application name
   */
  protected String getAppName(GenericKubernetesResource item) {
<span class="nc" id="L200">    return item.getMetadata().getName().toLowerCase();</span>
  }

  /**
   * Returns the application group. Defaults to resource namespace in lowercase.
   *
   * @param item the Kubernetes generic resource
   * @return application group
   */
  protected String getAppGroup(GenericKubernetesResource item) {
<span class="fc" id="L210">    return item.getMetadata().getNamespace().toLowerCase();</span>
  }

  /**
   * Returns the application URL from the resource.
   *
   * @param item the Kubernetes generic resource
   * @return URL string or null if not provided
   */
  protected String getAppUrl(GenericKubernetesResource item) {
<span class="nc" id="L220">    return null;</span>
  }

  /**
   * Returns the application icon from the resource.
   *
   * @param item the Kubernetes generic resource
   * @return icon string or null if not provided
   */
  protected String getAppIcon(GenericKubernetesResource item) {
<span class="fc" id="L230">    return null;</span>
  }

  /**
   * Returns the application icon color from the resource.
   *
   * @param item the Kubernetes generic resource
   * @return icon color string or null if not provided
   */
  protected String getAppIconColor(GenericKubernetesResource item) {
<span class="fc" id="L240">    return null;</span>
  }

  /**
   * Returns application info from the resource.
   *
   * @param item the Kubernetes generic resource
   * @return info string or null if not provided
   */
  protected String getAppInfo(GenericKubernetesResource item) {
<span class="fc" id="L250">    return null;</span>
  }

  /**
   * Returns whether the application URL should open in a new tab.
   *
   * @param item the Kubernetes generic resource
   * @return Boolean flag or false if not specified
   */
  @Nullable
  protected Boolean getAppTargetBlank(GenericKubernetesResource item) {
<span class="fc" id="L261">    return false;</span>
  }

  /**
   * Returns the sorting location for the application.
   *
   * @param item the Kubernetes generic resource
   * @return integer location, default is 1000
   */
  protected int getAppLocation(GenericKubernetesResource item) {
<span class="fc" id="L271">    return 1000;</span>
  }

  /**
   * Returns whether the application is enabled.
   *
   * @param item the Kubernetes generic resource
   * @return Boolean flag or false if not specified
   */
  @Nullable
  protected Boolean getAppEnabled(GenericKubernetesResource item) {
<span class="fc" id="L282">    return false;</span>
  }

  /**
   * Returns the protocol of the application URL.
   *
   * @param item the Kubernetes generic resource
   * @return protocol string or null if not specified
   */
  protected String getAppProtocol(GenericKubernetesResource item) {
<span class="nc" id="L292">    return null;</span>
  }

  /**
   * Returns the tags of the application. By default, reads from the &quot;startpunkt.ullberg.us/tags&quot;
   * annotation.
   *
   * @param item the Kubernetes generic resource
   * @return comma-separated tags string or null if not set
   */
  protected String getAppTags(GenericKubernetesResource item) {
<span class="fc" id="L303">    var annotations = getAnnotations(item);</span>
<span class="pc bpc" id="L304" title="1 of 4 branches missed.">    if (annotations != null &amp;&amp; annotations.containsKey(&quot;startpunkt.ullberg.us/tags&quot;)) {</span>
<span class="fc" id="L305">      return annotations.get(&quot;startpunkt.ullberg.us/tags&quot;);</span>
    }
<span class="fc" id="L307">    return null;</span>
  }

  /**
   * Retrieves a string property from the spec or returns a fallback value.
   *
   * @param item the Kubernetes generic resource
   * @param key the key to lookup in the spec
   * @param fallback fallback value if key is absent
   * @return value from spec or fallback
   */
  protected String getOptionalSpecString(
      GenericKubernetesResource item, String key, String fallback) {
<span class="fc" id="L320">    var spec = getSpec(item);</span>
<span class="pc bpc" id="L321" title="1 of 4 branches missed.">    return spec != null &amp;&amp; spec.containsKey(key) ? spec.get(key).toString() : fallback;</span>
  }

  /**
   * Retrieves a boolean property from the spec or returns a fallback value.
   *
   * @param item the Kubernetes generic resource
   * @param key the key to lookup in the spec
   * @param fallback fallback boolean value if key is absent
   * @return boolean value from spec or fallback
   */
  protected Boolean getOptionalSpecBoolean(
      GenericKubernetesResource item, String key, Boolean fallback) {
<span class="fc" id="L334">    var spec = getSpec(item);</span>
<span class="pc bpc" id="L335" title="2 of 4 branches missed.">    return spec != null &amp;&amp; spec.containsKey(key)</span>
<span class="fc" id="L336">        ? Boolean.parseBoolean(spec.get(key).toString())</span>
<span class="nc" id="L337">        : fallback;</span>
  }

  /**
   * Retrieves an integer property from the spec or returns a fallback value.
   *
   * @param item the Kubernetes generic resource
   * @param key the key to lookup in the spec
   * @param fallback fallback integer value if key is absent
   * @return integer value from spec or fallback
   */
  protected Integer getOptionalSpecInteger(
      GenericKubernetesResource item, String key, Integer fallback) {
<span class="fc" id="L350">    var spec = getSpec(item);</span>
<span class="pc bpc" id="L351" title="2 of 4 branches missed.">    return spec != null &amp;&amp; spec.containsKey(key)</span>
<span class="fc" id="L352">        ? Integer.parseInt(spec.get(key).toString())</span>
<span class="nc" id="L353">        : fallback;</span>
  }

  /**
   * Retrieves the application root path from resource annotations.
   *
   * @param item Kubernetes resource
   * @return root path string or null if not found
   */
  protected String getAppRootPath(GenericKubernetesResource item) {
<span class="fc" id="L363">    var annotations = getAnnotations(item);</span>
<span class="pc bpc" id="L364" title="2 of 4 branches missed.">    if (annotations != null &amp;&amp; annotations.containsKey(&quot;startpunkt.ullberg.us/rootPath&quot;)) {</span>
<span class="nc" id="L365">      return annotations.get(&quot;startpunkt.ullberg.us/rootPath&quot;);</span>
    }
<span class="fc" id="L367">    return null;</span>
  }

  /**
   * Appends the root path to the URL if a rootPath annotation is present.
   *
   * @param url base URL
   * @param item Kubernetes resource to get rootPath from
   * @return URL with rootPath appended or original URL if no rootPath
   */
  protected String appendRootPath(String url, GenericKubernetesResource item) {
<span class="pc bpc" id="L378" title="1 of 2 branches missed.">    if (url == null) {</span>
<span class="nc" id="L379">      return null;</span>
    }

<span class="fc" id="L382">    String rootPath = getAppRootPath(item);</span>
<span class="pc bpc" id="L383" title="3 of 4 branches missed.">    if (rootPath != null &amp;&amp; !rootPath.isEmpty()) {</span>
<span class="nc" id="L384">      return appendRootPath(url, rootPath);</span>
    }
<span class="fc" id="L386">    return url;</span>
  }

  /**
   * Appends the root path to the URL.
   *
   * @param url base URL
   * @param rootPath root path to append
   * @return URL with rootPath appended
   */
  protected String appendRootPath(String url, String rootPath) {
<span class="nc bnc" id="L397" title="All 2 branches missed.">    if (url == null) {</span>
<span class="nc" id="L398">      return null;</span>
    }

<span class="nc bnc" id="L401" title="All 4 branches missed.">    if (rootPath != null &amp;&amp; !rootPath.isEmpty()) {</span>
      // Ensure the URL doesn't end with a slash and rootPath starts with a slash
<span class="nc bnc" id="L403" title="All 2 branches missed.">      String normalizedUrl = url.endsWith(&quot;/&quot;) ? url.substring(0, url.length() - 1) : url;</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">      String normalizedRootPath = rootPath.startsWith(&quot;/&quot;) ? rootPath : &quot;/&quot; + rootPath;</span>
<span class="nc" id="L405">      return normalizedUrl + normalizedRootPath;</span>
    }
<span class="nc" id="L407">    return url;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>