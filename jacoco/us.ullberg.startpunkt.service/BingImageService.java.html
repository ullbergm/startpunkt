<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BingImageService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">startpunkt</a> &gt; <a href="index.source.html" class="el_package">us.ullberg.startpunkt.service</a> &gt; <span class="el_source">BingImageService.java</span></div><h1>BingImageService.java</h1><pre class="source lang-java linenums">package us.ullberg.startpunkt.service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.micrometer.core.annotation.Timed;
import io.quarkus.cache.CacheResult;
import io.quarkus.logging.Log;
import io.smallrye.faulttolerance.api.CircuitBreakerName;
import jakarta.enterprise.context.ApplicationScoped;
import java.io.IOException;
import java.net.URI;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import org.eclipse.microprofile.config.inject.ConfigProperty;
import org.eclipse.microprofile.faulttolerance.CircuitBreaker;
import org.eclipse.microprofile.faulttolerance.Fallback;
import org.eclipse.microprofile.faulttolerance.Timeout;
import us.ullberg.startpunkt.objects.bingimage.BingImage;

/**
 * Service for fetching and caching Bing's Image of the Day. The base URL from Bing API is cached
 * for 1 hour, and resolution selection is performed based on client aspect ratio.
 */
@ApplicationScoped
public class BingImageService {

  private static final String BING_API_URL =
      &quot;https://www.bing.com/HPImageArchive.aspx?format=js&amp;idx=0&amp;n=1&quot;;
  private static final String BING_IMAGE_BASE_URL = &quot;https://www.bing.com&quot;;

  private final ObjectMapper objectMapper;
  private final HttpClient httpClient;

  @ConfigProperty(
      name = &quot;startpunkt.bingimage.fallback.urlbase&quot;,
      defaultValue = &quot;/th?id=OHR.MexicoJelly_EN-US6803524310&quot;)
  String fallbackUrlBase;

  @ConfigProperty(name = &quot;startpunkt.bingimage.fallback.copyright&quot;, defaultValue = &quot;Fallback Image&quot;)
  String fallbackCopyright;

  @ConfigProperty(name = &quot;startpunkt.bingimage.fallback.title&quot;, defaultValue = &quot;Default Background&quot;)
  String fallbackTitle;

  /**
   * Constructor initializes HTTP client and injects ObjectMapper.
   *
   * @param objectMapper Jackson ObjectMapper for JSON parsing
   */
<span class="fc" id="L53">  public BingImageService(ObjectMapper objectMapper) {</span>
<span class="fc" id="L54">    this.objectMapper = objectMapper;</span>
<span class="fc" id="L55">    this.httpClient = HttpClient.newHttpClient();</span>
<span class="fc" id="L56">  }</span>

  /**
   * Fetches Bing Image of the Day with optimal resolution for the given screen dimensions. The base
   * URL data is cached for 1 hour to minimize API calls.
   *
   * @param width client screen width in pixels
   * @param height client screen height in pixels
   * @return BingImage with optimized URL and metadata
   */
  @Timed(
      value = &quot;startpunkt.bingimage.fetch&quot;,
      description = &quot;Fetch Bing Image of the Day with resolution optimization&quot;)
  public BingImage getBingImageOfDay(int width, int height) {
<span class="fc" id="L70">    Log.debugf(&quot;Getting Bing Image of the Day for resolution: %dx%d&quot;, width, height);</span>

    try {
      // Fetch cached base data from Bing API (cached for 1 hour)
<span class="fc" id="L74">      BingImageData baseData = fetchBingImageData();</span>

      // Determine best resolution based on client screen dimensions
<span class="fc" id="L77">      String resolution = getBestResolutionForAspectRatio(width, height);</span>

      // Build complete image URL with selected resolution
<span class="fc" id="L80">      String imageUrl = BING_IMAGE_BASE_URL + baseData.urlbase() + &quot;_&quot; + resolution + &quot;.jpg&quot;;</span>

<span class="fc" id="L82">      Log.debugf(</span>
          &quot;Bing image URL constructed: %s for date: %s with resolution: %s&quot;,
<span class="fc" id="L84">          imageUrl, baseData.date(), resolution);</span>

<span class="fc" id="L86">      return new BingImage(imageUrl, baseData.copyright(), baseData.title(), baseData.date());</span>
<span class="nc" id="L87">    } catch (Exception e) {</span>
      // If fetching fails, return fallback image
<span class="nc" id="L89">      Log.warnf(e, &quot;Failed to fetch Bing Image of the Day, using fallback image&quot;);</span>
<span class="nc" id="L90">      return getFallbackImage(width, height);</span>
    }
  }

  /**
   * Fetches the base image data from Bing API. This method is cached for 1 hour to reduce API
   * calls. Includes circuit breaker to handle API failures gracefully.
   *
   * @return BingImageData containing urlbase and metadata
   * @throws IOException if the API call fails
   */
  @CacheResult(cacheName = &quot;bing-image-base-cache&quot;)
  @Timeout(value = 10000) // 10 second timeout
  @CircuitBreaker(
      requestVolumeThreshold = 4,
      failureRatio = 0.5,
      delay = 60000,
      successThreshold = 2)
  @CircuitBreakerName(&quot;bing-api&quot;)
  @Fallback(fallbackMethod = &quot;fetchBingImageDataFallback&quot;)
  BingImageData fetchBingImageData() throws IOException {
<span class="fc" id="L111">    Log.debug(&quot;Fetching base image data from Bing API (cache miss)&quot;);</span>

    try {
<span class="fc" id="L114">      HttpRequest request = HttpRequest.newBuilder().uri(URI.create(BING_API_URL)).GET().build();</span>

<span class="fc" id="L116">      HttpResponse&lt;String&gt; response =</span>
<span class="fc" id="L117">          httpClient.send(request, HttpResponse.BodyHandlers.ofString());</span>

<span class="pc bpc" id="L119" title="1 of 2 branches missed.">      if (response.statusCode() != 200) {</span>
<span class="nc" id="L120">        throw new IOException(</span>
            &quot;Bing API returned status code: &quot;
<span class="nc" id="L122">                + response.statusCode()</span>
                + &quot;, body: &quot;
<span class="nc" id="L124">                + response.body());</span>
      }

      // Parse JSON response
<span class="fc" id="L128">      JsonNode root = objectMapper.readTree(response.body());</span>
<span class="fc" id="L129">      JsonNode images = root.path(&quot;images&quot;);</span>

<span class="pc bpc" id="L131" title="2 of 4 branches missed.">      if (!images.isArray() || images.isEmpty()) {</span>
<span class="nc" id="L132">        throw new IOException(&quot;No images found in Bing API response&quot;);</span>
      }

<span class="fc" id="L135">      JsonNode image = images.get(0);</span>
<span class="fc" id="L136">      String urlbase = image.path(&quot;urlbase&quot;).asText();</span>
<span class="fc" id="L137">      String copyright = image.path(&quot;copyright&quot;).asText();</span>
<span class="fc" id="L138">      String title = image.path(&quot;title&quot;).asText();</span>
<span class="fc" id="L139">      String startdate = image.path(&quot;startdate&quot;).asText();</span>

<span class="pc bpc" id="L141" title="1 of 2 branches missed.">      if (urlbase.isEmpty()) {</span>
<span class="nc" id="L142">        throw new IOException(&quot;Urlbase is empty in Bing API response&quot;);</span>
      }

<span class="fc" id="L145">      return new BingImageData(urlbase, copyright, title, startdate);</span>

<span class="nc" id="L147">    } catch (InterruptedException e) {</span>
<span class="nc" id="L148">      Thread.currentThread().interrupt();</span>
<span class="nc" id="L149">      throw new IOException(&quot;Request was interrupted&quot;, e);</span>
<span class="nc" id="L150">    } catch (Exception e) {</span>
<span class="nc" id="L151">      Log.errorf(e, &quot;Error fetching Bing Image of the Day base data&quot;);</span>
<span class="nc" id="L152">      throw new IOException(&quot;Failed to fetch Bing Image of the Day&quot;, e);</span>
    }
  }

  /**
   * Fallback method for fetchBingImageData when the circuit breaker is open or the API call fails.
   *
   * @return BingImageData with fallback values
   */
  BingImageData fetchBingImageDataFallback() {
<span class="nc" id="L162">    Log.warn(&quot;Using fallback data for Bing Image (circuit breaker open or API unavailable)&quot;);</span>
<span class="nc" id="L163">    String today = LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE);</span>
<span class="nc" id="L164">    return new BingImageData(fallbackUrlBase, fallbackCopyright, fallbackTitle, today);</span>
  }

  /**
   * Provides a fallback image when Bing API is unavailable.
   *
   * @param width client screen width in pixels
   * @param height client screen height in pixels
   * @return BingImage with fallback image URL and metadata
   */
  private BingImage getFallbackImage(int width, int height) {
<span class="nc" id="L175">    String resolution = getBestResolutionForAspectRatio(width, height);</span>
<span class="nc" id="L176">    String imageUrl = BING_IMAGE_BASE_URL + fallbackUrlBase + &quot;_&quot; + resolution + &quot;.jpg&quot;;</span>
<span class="nc" id="L177">    String today = LocalDate.now().format(DateTimeFormatter.BASIC_ISO_DATE);</span>

<span class="nc" id="L179">    Log.debugf(&quot;Using fallback image URL: %s&quot;, imageUrl);</span>

<span class="nc" id="L181">    return new BingImage(imageUrl, fallbackCopyright, fallbackTitle, today);</span>
  }

  /**
   * Determines the best Bing image resolution based on client screen aspect ratio and dimensions.
   * Prioritizes finding the closest aspect ratio match, then selects appropriate resolution.
   *
   * @param width screen width in pixels
   * @param height screen height in pixels
   * @return resolution string (e.g., &quot;1920x1080&quot;, &quot;UHD&quot;, &quot;768x1280&quot;)
   */
  private String getBestResolutionForAspectRatio(int width, int height) {
<span class="fc" id="L193">    double aspectRatio = (double) width / height;</span>
<span class="fc bfc" id="L194" title="All 2 branches covered.">    boolean isPortrait = height &gt; width;</span>

<span class="fc" id="L196">    Log.debugf(</span>
        &quot;Calculating best resolution for %dx%d (aspect ratio: %.2f, portrait: %b)&quot;,
<span class="fc" id="L198">        width, height, aspectRatio, isPortrait);</span>

    // Ultra high resolution
<span class="pc bpc" id="L201" title="1 of 4 branches missed.">    if (width &gt;= 3840 || height &gt;= 2160) {</span>
<span class="fc" id="L202">      return &quot;UHD&quot;;</span>
    }

    // Portrait mode resolutions
<span class="fc bfc" id="L206" title="All 2 branches covered.">    if (isPortrait) {</span>
<span class="pc bpc" id="L207" title="2 of 4 branches missed.">      if (width &gt;= 768 &amp;&amp; height &gt;= 1280) {</span>
<span class="fc" id="L208">        return &quot;768x1280&quot;; // 0.6 aspect ratio</span>
      }
<span class="nc bnc" id="L210" title="All 4 branches missed.">      if (width &gt;= 720 &amp;&amp; height &gt;= 1280) {</span>
<span class="nc" id="L211">        return &quot;720x1280&quot;; // 0.5625 aspect ratio</span>
      }
<span class="nc bnc" id="L213" title="All 4 branches missed.">      if (width &gt;= 480 &amp;&amp; height &gt;= 800) {</span>
<span class="nc" id="L214">        return &quot;480x800&quot;; // 0.6 aspect ratio</span>
      }
<span class="nc bnc" id="L216" title="All 4 branches missed.">      if (width &gt;= 240 &amp;&amp; height &gt;= 320) {</span>
<span class="nc" id="L217">        return &quot;240x320&quot;; // 0.75 aspect ratio</span>
      }
<span class="nc" id="L219">      return &quot;320x240&quot;; // Fallback</span>
    }

    // Landscape mode resolutions - match by aspect ratio
    // Wide aspect ratios (16:10 = 1.6, 16:9 = 1.78, 4:3 = 1.33)

<span class="pc bpc" id="L225" title="1 of 4 branches missed.">    if (aspectRatio &gt;= 1.55 &amp;&amp; aspectRatio &lt;= 1.65) {</span>
      // 16:10 aspect ratio
<span class="nc bnc" id="L227" title="All 4 branches missed.">      if (width &gt;= 1920 &amp;&amp; height &gt;= 1200) {</span>
<span class="nc" id="L228">        return &quot;1920x1200&quot;;</span>
      }
<span class="nc bnc" id="L230" title="All 4 branches missed.">      if (width &gt;= 1280 &amp;&amp; height &gt;= 768) {</span>
<span class="nc" id="L231">        return &quot;1280x768&quot;;</span>
      }
<span class="nc" id="L233">      return &quot;800x480&quot;;</span>
<span class="pc bpc" id="L234" title="1 of 4 branches missed.">    } else if (aspectRatio &gt;= 1.70 &amp;&amp; aspectRatio &lt;= 1.85) {</span>
      // 16:9 aspect ratio
<span class="pc bpc" id="L236" title="1 of 4 branches missed.">      if (width &gt;= 1920 &amp;&amp; height &gt;= 1080) {</span>
<span class="fc" id="L237">        return &quot;1920x1080&quot;;</span>
      }
<span class="pc bpc" id="L239" title="2 of 4 branches missed.">      if (width &gt;= 1366 &amp;&amp; height &gt;= 768) {</span>
<span class="fc" id="L240">        return &quot;1366x768&quot;;</span>
      }
<span class="nc" id="L242">      return &quot;800x480&quot;;</span>
<span class="pc bpc" id="L243" title="2 of 4 branches missed.">    } else if (aspectRatio &gt;= 1.25 &amp;&amp; aspectRatio &lt;= 1.40) {</span>
      // 4:3 aspect ratio
<span class="pc bpc" id="L245" title="1 of 4 branches missed.">      if (width &gt;= 1024 &amp;&amp; height &gt;= 768) {</span>
<span class="fc" id="L246">        return &quot;1024x768&quot;;</span>
      }
<span class="pc bpc" id="L248" title="1 of 4 branches missed.">      if (width &gt;= 800 &amp;&amp; height &gt;= 600) {</span>
<span class="fc" id="L249">        return &quot;800x600&quot;;</span>
      }
<span class="pc bpc" id="L251" title="2 of 4 branches missed.">      if (width &gt;= 640 &amp;&amp; height &gt;= 480) {</span>
<span class="fc" id="L252">        return &quot;640x480&quot;;</span>
      }
<span class="nc" id="L254">      return &quot;320x240&quot;;</span>
<span class="nc bnc" id="L255" title="All 4 branches missed.">    } else if (aspectRatio &gt;= 1.62 &amp;&amp; aspectRatio &lt;= 1.70) {</span>
      // Between 16:10 and 16:9
<span class="nc bnc" id="L257" title="All 2 branches missed.">      if (width &gt;= 1920) {</span>
<span class="nc" id="L258">        return &quot;1920x1200&quot;;</span>
      }
<span class="nc bnc" id="L260" title="All 2 branches missed.">      if (width &gt;= 1366) {</span>
<span class="nc" id="L261">        return &quot;1366x768&quot;;</span>
      }
<span class="nc" id="L263">      return &quot;800x600&quot;;</span>
    }

    // Default fallback based on size
<span class="nc bnc" id="L267" title="All 2 branches missed.">    if (width &gt;= 1920) {</span>
<span class="nc" id="L268">      return &quot;1920x1080&quot;;</span>
    }
<span class="nc bnc" id="L270" title="All 2 branches missed.">    if (width &gt;= 1366) {</span>
<span class="nc" id="L271">      return &quot;1366x768&quot;;</span>
    }
<span class="nc bnc" id="L273" title="All 2 branches missed.">    if (width &gt;= 1024) {</span>
<span class="nc" id="L274">      return &quot;1024x768&quot;;</span>
    }
<span class="nc bnc" id="L276" title="All 2 branches missed.">    if (width &gt;= 800) {</span>
<span class="nc" id="L277">      return &quot;800x600&quot;;</span>
    }
<span class="nc bnc" id="L279" title="All 2 branches missed.">    if (width &gt;= 640) {</span>
<span class="nc" id="L280">      return &quot;640x480&quot;;</span>
    }
<span class="nc bnc" id="L282" title="All 2 branches missed.">    if (width &gt;= 400) {</span>
<span class="nc" id="L283">      return &quot;400x240&quot;;</span>
    }
<span class="nc" id="L285">    return &quot;320x240&quot;;</span>
  }

  /**
   * Internal record to hold Bing image base data from API.
   *
   * @param urlbase base URL path for the image
   * @param copyright copyright information
   * @param title image title
   * @param date image date in YYYYMMDD format
   */
<span class="fc" id="L296">  record BingImageData(String urlbase, String copyright, String title, String date) {}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>